<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebRTC Screen Sharing</title>

    <script>
        if (!location.hash.replace('#', '').length) {
            location.href = location.href.split('#')[0] + '#' + (Math.random() * 100).toString().replace('.', '');
            location.reload();
        }
    </script>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="css/Style.css" rel="stylesheet" />
    <link rel="author" type="text/html" href="http://immanuel.co">
    <meta name="author" content="Immanuel Raj">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <style>
        video {
            -moz-transition: all 1s ease;
            -ms-transition: all 1s ease;
            -o-transition: all 1s ease;
            -webkit-transition: all 1s ease;
            transition: all 1s ease;
            vertical-align: top;
            width: 100%;
        }

        input {
            border: 1px solid #d9d9d9;
            border-radius: 1px;
            font-size: 2em;
            margin: .2em;
            width: 30%;
        }

        select {
            border: 1px solid #d9d9d9;
            border-radius: 1px;
            height: 50px;
            margin-left: 1em;
            margin-right: -12px;
            padding: 1.1em;
            vertical-align: 6px;
            width: 18%;
        }

        .setup {
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
            font-size: 102%;
            height: 47px;
            margin-left: -9px;
            margin-top: 8px;
            position: absolute;
        }

        p {
            padding: 1em;
        }

        li {
            border-bottom: 1px solid rgb(189, 189, 189);
            border-left: 1px solid rgb(189, 189, 189);
            padding: .5em;
        }
    </style>
    <script>
        document.createElement('article');
        document.createElement('footer');
    </script>

    <!--<link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/immanuel-screen-capturing/khfdkbmniokcmlhnmfgnclefdihmndod">-->
    <link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod">

    <!-- scripts used for screen-sharing -->
    <script src="Scripts/socket.io.js"></script>
    <script src="Scripts/getScreenId.js"></script>
    <script src="Scripts/BandwidthHandler.js"></script>
    <script src="Scripts/screen.js"></script>
</head>

<body style="text-align:center;align-content:center;">
    <article style="background-color: cadetblue;border-radius:8px;box-shadow:10px 10px 15px #888888;width:85%;margin-left: auto; margin-right: auto;">
        <header style="text-align: center;font-family: Verdana, Geneva, Tahoma, sans-serif;">
            <h1 style="margin:10px;padding-top:30px;font-family: 'Poor Richard';font-size: xx-large;color:azure;">
                Immanuel's Trial on (WebRTC)
            </h1>
        </header>

        <div class="github-stargazers"></div>
        <h3 id="number-of-participants" style="display:block;text-align:center;border:0;margin-bottom:0;font-size:smaller;">Its a screen sharing app - derived from <a target="_blank" href="https://www.webrtc-experiment.com/">Muaz's</a>!</h3>
        <br />
        <!-- just copy this <section> and next script -->
        <section class="experiment">
            <section style="position:relative;">
                <!--<span>
                    Private ?? <a href="/screen-sharing/" target="_blank" title="Open this link for private screen sharing!"><code><strong id="unique-token">#123456789</strong></code></a>
                </span>-->
                <input type="text" style="margin-top:5px;margin-left:-300px;" id="user-name" placeholder="&nbsp; Your Name">
                <!--<button id="share-screen" class="setup">Share Your Screen</button>-->
                <button style="margin-top:3px;margin-left:3px;cursor:pointer;" id="share-screen" alt="Share your screen" class="action-button shadow animate orange setup">Share Your Screen</button>
                <!--<button style="margin-top:3px;margin-left:200px;cursor:pointer;" alt="Share your screen" class="action-button shadow animate orange setup">Share Your Screen</button>-->
                <span><a href="/screen-sharing/" target="_blank" title="Open this link for private screen sharing!" style="margin-top:3px;margin-left:200px;cursor:pointer;" alt="Share your screen" class="action-button shadow animate orange setup"><code><strong id="unique-token">#123456789</strong></code></a></span>
</section>
            <br />
            <!-- list of all available broadcasting rooms -->
            <table style="width: 100%;" id="rooms-list"></table>

            <!-- local/remote videos container -->
            <div id="videos-container"></div>
        </section>

        <script>
            // Muaz Khan     - https://github.com/muaz-khan
            // MIT License   - https://www.webrtc-experiment.com/licence/
            // Documentation - https://github.com/muaz-khan/WebRTC-Experiment/tree/master/screen-sharing

            var videosContainer = document.getElementById("videos-container") || document.body;
            var roomsList = document.getElementById('rooms-list');

            var screensharing = new Screen();

            var channel = location.href.replace(/\/|:|#|%|\.|\[|\]/g, '');
            var sender = Math.round(Math.random() * 999999999) + 999999999;

            var SIGNALING_SERVER = 'https://webrtcweb.com:9559/';
            io.connect(SIGNALING_SERVER).emit('new-channel', {
                channel: channel,
                sender: sender
            });

            var socket = io.connect(SIGNALING_SERVER + channel);
            socket.on('connect', function () {
                // setup peer connection & pass socket object over the constructor!
            });

            socket.send = function (message) {
                socket.emit('message', {
                    sender: sender,
                    data: message
                });
            };

            screensharing.openSignalingChannel = function (callback) {
                return socket.on('message', callback);
            };

            screensharing.onscreen = function (_screen) {
                var alreadyExist = document.getElementById(_screen.userid);
                if (alreadyExist) return;

                if (typeof roomsList === 'undefined') roomsList = document.body;

                var tr = document.createElement('tr');

                tr.id = _screen.userid;
                tr.innerHTML = '<td>' + _screen.userid + ' shared his screen.</td>' +
                    '<td><button class="join">Preview His Screen</button></td>';
                roomsList.insertBefore(tr, roomsList.firstChild);

                var button = tr.querySelector('.join');
                button.setAttribute('data-userid', _screen.userid);
                button.setAttribute('data-roomid', _screen.roomid);
                button.onclick = function () {
                    var button = this;
                    button.disabled = true;

                    var _screen = {
                        userid: button.getAttribute('data-userid'),
                        roomid: button.getAttribute('data-roomid')
                    };
                    screensharing.view(_screen);
                };
            };

            // on getting each new screen
            screensharing.onaddstream = function (media) {
                media.video.id = media.userid;

                var video = media.video;
                video.setAttribute('controls', true);
                videosContainer.insertBefore(video, videosContainer.firstChild);
                video.play();
                //rotateVideo(video);
            };

            // using firebase for signaling
            // screen.firebase = 'signaling';

            // if someone leaves; just remove his screen
            screensharing.onuserleft = function (userid) {
                var video = document.getElementById(userid);
                if (video && video.parentNode) video.parentNode.removeChild(video);
            };

            // check pre-shared screens
            screensharing.check();

            document.getElementById('share-screen').onclick = function () {
                screensharing.share();
                this.disabled = true;
            };

            document.getElementById('share-screen').onclick = function () {
                var username = document.getElementById('user-name');
                username.disabled = this.disabled = true;

                screensharing.isModerator = true;
                screensharing.userid = username.value;

                screensharing.share();
            };

            function rotateVideo(video) {
                video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
                setTimeout(function () {
                    video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
                }, 1000);
            }

            (function () {
                var uniqueToken = document.getElementById('unique-token');
                if (uniqueToken)
                    if (location.hash.length > 2) {
                        uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<a href="' + location.href + '" class="action-button shadow animate green setup tooltip" target="_blank" style="margin-top:3px;margin-left:190px;cursor:pointer;height:20px;">Share this link<span class="tooltiptext">' + location.href + '</span></a>';
                    }
                    else {
                        uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace(/\./g, '-');
                    }
            })();

            screensharing.onNumberOfParticipantsChnaged = function (numberOfParticipants) {
                if (!screensharing.isModerator) return;

                document.title = numberOfParticipants + ' users are viewing your screen!';
                var element = document.getElementById('number-of-participants');
                if (element) {
                    element.innerHTML = numberOfParticipants + ' users are viewing your screen!';
                }
            };

            var loadExtn = function () {
                if (!!navigator.webkitGetUserMedia && !!window.chrome && !!chrome.webstore && !!chrome.webstore.install) {
                    chrome.webstore.install('https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod', function () {
                        location.reload();
                    });
                }
            }
        </script>

        <script>
            // todo: need to check exact chrome browser because opera also uses chromium framework
            var isChrome = !!navigator.webkitGetUserMedia;

            // DetectRTC.js - https://github.com/muaz-khan/WebRTC-Experiment/tree/master/DetectRTC
            // Below code is taken from RTCMultiConnection-v1.8.js (http://www.rtcmulticonnection.org/changes-log/#v1.8)
            var DetectRTC = {};

            (function () {

                var screenCallback;

                DetectRTC.screen = {
                    chromeMediaSource: 'screen',
                    getSourceId: function (callback) {
                        if (!callback) throw '"callback" parameter is mandatory.';
                        screenCallback = callback;
                        window.postMessage('get-sourceId', '*');
                    },
                    isChromeExtensionAvailable: function (callback) {
                        if (!callback) return;

                        if (DetectRTC.screen.chromeMediaSource == 'desktop') return callback(true);

                        // ask extension if it is available
                        window.postMessage('are-you-there', '*');

                        setTimeout(function () {
                            if (DetectRTC.screen.chromeMediaSource == 'screen') {
                                callback(false);
                            }
                            else callback(true);
                        }, 2000);
                    },
                    onMessageCallback: function (data) {
                        if (!(typeof data == 'string' || !!data.sourceId)) return;

                        console.log('chrome message', data);

                        // "cancel" button is clicked
                        if (data == 'PermissionDeniedError') {
                            DetectRTC.screen.chromeMediaSource = 'PermissionDeniedError';
                            if (screenCallback) return screenCallback('PermissionDeniedError');
                            else throw new Error('PermissionDeniedError');
                        }

                        // extension notified his presence
                        if (data == 'rtcmulticonnection-extension-loaded') {
                            if (document.getElementById('install-button')) {
                                document.getElementById('install-button').parentNode.innerHTML = '<strong>Great!</strong> <a href="https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod" target="_blank">Google chrome extension</a> is installed.';
                                document.getElementById('cls-wrp').style = "";
                            }
                            DetectRTC.screen.chromeMediaSource = 'desktop';
                        }

                        // extension shared temp sourceId
                        if (data.sourceId) {
                            DetectRTC.screen.sourceId = data.sourceId;
                            if (screenCallback) screenCallback(DetectRTC.screen.sourceId);
                        }
                    },
                    getChromeExtensionStatus: function (callback) {
                        if (!!navigator.mozGetUserMedia) return callback('not-chrome');

                        var extensionid = 'khfdkbmniokcmlhnmfgnclefdihmndod';

                        var image = document.createElement('img');
                        image.src = 'chrome-extension://' + extensionid + '/icon.png';
                        image.onload = function () {
                            DetectRTC.screen.chromeMediaSource = 'screen';
                            window.postMessage('are-you-there', '*');
                            setTimeout(function () {
                                if (!DetectRTC.screen.notInstalled) {
                                    callback('installed-enabled');
                                }
                            }, 2000);
                        };
                        image.onerror = function () {
                            DetectRTC.screen.notInstalled = true;
                            callback('not-installed');
                        };
                    }
                };

                // check if desktop-capture extension installed.
                if (window.postMessage && isChrome) {
                    DetectRTC.screen.isChromeExtensionAvailable();
                }
            })();

            DetectRTC.screen.getChromeExtensionStatus(function (status) {
                if (status == 'installed-enabled') {
                    if (document.getElementById('install-button')) {
                        document.getElementById('install-button').parentNode.innerHTML = '<strong>Great!</strong> <a href="https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod" target="_blank">Google chrome extension</a> is installed.';
                        document.getElementById('cls-wrp').style = "";
                    }
                    DetectRTC.screen.chromeMediaSource = 'desktop';
                }
            });

            window.addEventListener('message', function (event) {
                if (event.origin != window.location.origin) {
                    return;
                }

                DetectRTC.screen.onMessageCallback(event.data);
            });

            console.log('current chromeMediaSource', DetectRTC.screen.chromeMediaSource);
        </script>

        <section class="experiment" style="background-color:bisque;">
            <h2 style="padding-top:20px;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color: crimson;margin:0px;">PreRequisites</h2>
            <br />
            <div style="font-family:'Berlin Sans FB';font-size:x-large;color:#12752d;">
                <strong>Firefox?</strong> Please use version 52 or higher. Also use HTTPs. (Highly Recommended - Very Simple)
            </div>
            <br />
            <div style="font-family:'Berlin Sans FB';font-size:x-large;color:#12752d;">
                <div id="cls-wrp" style="margin-left:-225px;">
                    Chrome?
                    <!--<a href="https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod" target="_blank">Store</a>-->
                    <a href="https://chrome.google.com/webstore/detail/khfdkbmniokcmlhnmfgnclefdihmndod" target="_blank" alt="Immanuel Share Screed- Chrome extension" class="action-button shadow animate bluegrn" style="position:absolute;margin-left:20px; margin-top:0px;padding: 2px 2px;">Store</a>

                    <!--<button onclick="loadExtn();" id="install-button" style="font-size:inherit; padding-bottom:0;">Click to Install</button>-->
                    <a onclick="loadExtn();" id="install-button" alt="Install web store extension" class="action-button shadow animate pgreen" style="position:absolute;margin-left:80px; margin-top:0px;padding: 2px 2px;cursor:pointer;">Click to Install</a>
                </div>
            </div>
            <br />
            <div style="font-family:'Berlin Sans FB';font-size:x-large;color:#1b3ab1;">
                <strong style="background-color: gray;">Steps For Chrome: [Sad... :( ]</strong> 
                <br />
                <ul>
                    1. Install Chrome extension 
                    <br>&nbsp;&nbsp;&nbsp;<img src="img/chr_h2.png" width="250" height="70" />
                    <br /><br />2. after installtion..(below screen shot)
                    <br>&nbsp;&nbsp;&nbsp;
                    <img src="img/chr_h3.png" width="250" height="70" />
                    <br />
                    <br />3. open chrome with usermedia enabled..
                    <br>&nbsp;&nbsp;&nbsp; windows (PC): <span style="background-color:black;color:white;">chrome.exe --enable-usermedia-screen-capturing</span>
                    <br>&nbsp;&nbsp;&nbsp; mac: <span style="background-color:black;color:white;">sudo /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --enable-usermedia-screen-capturing</span>
                </ul>
            </div>
            <br />
        </section>

        <section class="experiment"><small id="send-message"></small></section>

    </article>

    <footer></footer>
</body>
</html>
